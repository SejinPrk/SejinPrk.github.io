---
layout: post
title: "[SQL]ë‹¨ë°©í–¥ í†µì‹ ìœ¼ë¡œ ì±„íŒ… ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°"
excerpt: "SQL"
categories:
  - Blog
tags:
  - [SQL]
toc: true
toc_sticky: true
date: 2024-12-04
last_modified_at: 2024-12-04
---
# SQL ì¬ê·€ ì¿¼ë¦¬ (Recursive Query) ì™„ë²½ ê°€ì´ë“œ

ê´€ë¦¬ì í”„ë¡œì íŠ¸ë¥¼ ì‘ì—…í•˜ë˜ ë„ì¤‘ ì¬ê·€ ì¿¼ë¦¬ë¥¼ ë§ˆì£¼í•˜ëŠ” ì¼ì´ ìƒê²¼ë‹¤. 

ì´ì „ê¹Œì§€ ë‹¤ì–‘í•œ ì¡°ì¸ì€ í•´ë´¤ì–´ë„ ë¦¬ì»¤ì‹œë¸Œ ì¿¼ë¦¬ëŠ” ì²˜ìŒ ë“£ëŠ”ë°, ì‚¬ì› ì •ë³´ë¥¼ ì¡°íšŒí•  ë•Œ í…Œì´ë¸”ì— ì´ì— ëŒ€í•œ ì»¬ëŸ¼ì´ ì—†ì–´ ê³„ì¸µì„ íƒ€ê³  íƒ€ê³  ë“¤ì–´ê°€ì•¼ í•˜ëŠ” ìƒí™©(ë¶€ì„œ â†’ íŒ€ â†’ ìœ ë‹›)ì´ ìƒê²¼ê³  ì²˜ìŒìœ¼ë¡œ ì¬ê·€ ì¿¼ë¦¬ì— ëŒ€í•´ ì•Œê²Œ ë˜ì—ˆë‹¤. ì¼ë°˜ CRUD ì‘ì—…ë³´ë‹¤ ì¿¼ë¦¬ ì‘ì„±ì´ë‚˜ ë””ë²„ê¹…ì´ ì–´ë ¤ì›Œì„œ ë”°ë¡œ ì¬ê·€ ì¿¼ë¦¬ì— ëŒ€í•´ì„œë§Œ ì •ë¦¬ë¥¼ í•´ë³´ê¸°ë¡œ í–ˆë‹¤. 

## 1. ì¬ê·€ ì¿¼ë¦¬(Recursive Query)ë€?

í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì— í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ìì‹ ì„ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ì¬ê·€ í•¨ìˆ˜(ex. factorial)ê°€ ìˆëŠ” ê²ƒì²˜ëŸ¼ SQL ë¬¸ë²•ì—ì„œë„ WITH RECURSIVEì™€ UNIONì„ í†µí•´ ë°˜ë³µ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì¬ê·€ ì¿¼ë¦¬ê°€ ìˆë‹¤. ì¬ê·€ ì¿¼ë¦¬ëŠ” ìê¸° ì°¸ì¡°(self-referencing) ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” SQL ì¿¼ë¦¬ë¡œ, ì£¼ë¡œ ê³„ì¸µì  ë°ì´í„°ë‚˜ ê·¸ë˜í”„ êµ¬ì¡°ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©ëœë‹¤.

### ì£¼ìš” í™œìš© ë¶„ì•¼

- ì¡°ì§ë„/ì§ì› ê³„ì¸µ êµ¬ì¡°
- ì¹´í…Œê³ ë¦¬ íŠ¸ë¦¬
- íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œ
- ë„¤íŠ¸ì›Œí¬ ê´€ê³„ë„
- ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ êµ¬ì¡°

## 2. WITH RECURSIVE ë¬¸ë²•

ê¸°ë³¸ ë¬¸ë²• êµ¬ì¡°:

```sql
WITH RECURSIVE cte_name AS (
    -- ê¸°ë³¸ ì¼€ì´ìŠ¤(Base case)
    SELECT columns
    FROM table
    WHERE condition

    UNION [ALL]

    -- ì¬ê·€ ì¼€ì´ìŠ¤(Recursive case)
    SELECT columns
    FROM table
    INNER JOIN cte_name ON condition
)
SELECT * FROM cte_name;

```

### êµ¬ì„± ìš”ì†Œ ì„¤ëª…

1. **ê¸°ë³¸ ì¼€ì´ìŠ¤**
    - ì¬ê·€ì˜ ì‹œì‘ì 
    - ì´ˆê¸° ë°ì´í„° ì§‘í•© ì •ì˜
    - WHERE ì ˆë¡œ ì‹œì‘ ì¡°ê±´ ì§€ì •
2. **ì¬ê·€ ì¼€ì´ìŠ¤**
    - CTEë¥¼ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ ë°ì´í„° ìƒì„±
    - JOIN ì¡°ê±´ìœ¼ë¡œ ì¬ê·€ ê´€ê³„ ì •ì˜
    - ì¢…ë£Œ ì¡°ê±´ í¬í•¨ í•„ìš”

## 3. ì‚¬ìš© ì‚¬ë¡€

### (1) ì§ì› ì¡°ì§ë„ ì¡°íšŒ

```sql
WITH RECURSIVE emp_hierarchy AS (
    -- ìµœìƒìœ„ ê´€ë¦¬ì (ê¸°ë³¸ ì¼€ì´ìŠ¤)
    SELECT employee_id, name, manager_id, 1 as level
    FROM employees
    WHERE manager_id IS NULL

    UNION ALL

    -- í•˜ìœ„ ì§ì› (ì¬ê·€ ì¼€ì´ìŠ¤)
    SELECT e.employee_id, e.name, e.manager_id, h.level + 1
    FROM employees e
    INNER JOIN emp_hierarchy h ON e.manager_id = h.employee_id
)
SELECT * FROM emp_hierarchy;

```

### (2) ì¹´í…Œê³ ë¦¬ ì „ì²´ ê²½ë¡œ ìƒì„±

```sql
WITH RECURSIVE category_path AS (
    -- ìµœí•˜ìœ„ ì¹´í…Œê³ ë¦¬ (ê¸°ë³¸ ì¼€ì´ìŠ¤)
    SELECT id, name, parent_id, name as path
    FROM categories
    WHERE id = 5  -- íŠ¹ì • ì¹´í…Œê³ ë¦¬

    UNION ALL

    -- ìƒìœ„ ì¹´í…Œê³ ë¦¬ íƒìƒ‰ (ì¬ê·€ ì¼€ì´ìŠ¤)
    SELECT c.id, c.name, c.parent_id,
           c.name || ' > ' || cp.path
    FROM categories c
    INNER JOIN category_path cp ON c.id = cp.parent_id
)
SELECT path FROM category_path
WHERE parent_id IS NULL;

```

### (3) ìˆ«ì ì‹œí€€ìŠ¤ ìƒì„±

```sql
WITH RECURSIVE sequence AS (
    -- ì‹œì‘ ìˆ«ì (ê¸°ë³¸ ì¼€ì´ìŠ¤)
    SELECT 1 as number

    UNION ALL

    -- ë‹¤ìŒ ìˆ«ì ìƒì„± (ì¬ê·€ ì¼€ì´ìŠ¤)
    SELECT number + 1
    FROM sequence
    WHERE number < 10
)
SELECT * FROM sequence;

```

## 4. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

1. **ì¢…ë£Œ ì¡°ê±´ì˜ ì¤‘ìš”ì„±**
    - ëª…í™•í•œ ì¢…ë£Œ ì¡°ê±´ í•„ìˆ˜
    - ë¬´í•œ ë£¨í”„ ë°©ì§€
    - MAXRECURSION ì˜µì…˜ í™œìš©
2. **ì¸ë±ìŠ¤ ìµœì í™”**
    - ì¬ê·€ ì¡°ì¸ ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ìƒì„±
    - ì‹¤í–‰ ê³„íš ë¶„ì„
3. **ë©”ëª¨ë¦¬ ì‚¬ìš©**
    - ì¬ê·€ ê¹Šì´ì— ë”°ë¥¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
    - ë°ì´í„° ë³¼ë¥¨ ê³ ë ¤

## 5. ì£¼ì˜ì‚¬í•­ê³¼ ëª¨ë²” ì‚¬ë¡€

### âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ìˆœí™˜ ì°¸ì¡°(Circular Reference) ë°©ì§€ *** 
- ìˆœí™˜ì°¸ì¡°ë€? dbì—ì„œ ë ˆì½”ë“œë“¤ì´ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ë©° ìˆœí™˜í•˜ëŠ” êµ¬ì¡°ë¥¼ ì˜ë¯¸í•œë‹¤.
- ì´ëŸ° ìˆœí™˜ êµ¬ì¡°ëŠ”:
    1. ë¬´í•œ ë£¨í”„ ë°œìƒ ìœ„í—˜
    2. ë°ì´í„° ì¼ê´€ì„± ì €í•´
    3. ì¬ê·€ ì¿¼ë¦¬ ì‹œ ì„±ëŠ¥ ë¬¸ì œ
    
    ë•Œë¬¸ì— ë³´í†µ ë°ì´í„° ì„¤ê³„ ì‹œ ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì œì•½ì¡°ê±´ì„ ì„¤ì •í•œë‹¤.
    

```jsx
ì§ì› Aì˜ ë§¤ë‹ˆì € â†’ ì§ì›B
ì§ì› Bì˜ ë§¤ë‹ˆì € â†’ ì§ì›C
ì§ì› Cì˜ ë§¤ë‹ˆì € â†’ ì§ì›A  (ìˆœí™˜ ë°œìƒ)
```

- ë°ì´í„° ì •í•©ì„± í™•ì¸
- CYCLE ê°ì§€ ë¡œì§ êµ¬í˜„
1. **ê¹Šì´ ì œí•œ**
    - ìµœëŒ€ ì¬ê·€ ê¹Šì´ ì„¤ì •
    - ì„±ëŠ¥ ì €í•˜ ë°©ì§€

### ğŸ˜ ëª¨ë²” ì‚¬ë¡€

1. **ëª…í™•í•œ ì¢…ë£Œ ì¡°ê±´**

```sql
WHERE level <= 10  -- ëª…ì‹œì  ê¹Šì´ ì œí•œ
WHERE number < 100 -- ëª…í™•í•œ ë²”ìœ„ ì§€ì •
```

1. **ë°ì´í„° ê²€ì¦**

```sql
-- ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
WITH RECURSIVE cycle_check AS (
    SELECT id, parent_id, ARRAY[id] as path
    FROM tree_table
    WHERE id = 1

    UNION ALL

    SELECT t.id, t.parent_id, c.path || t.id
    FROM tree_table t
    JOIN cycle_check c ON t.parent_id = c.id
    WHERE NOT t.id = ANY(c.path)
)
SELECT * FROM cycle_check;
```

1. **ì„±ëŠ¥ ìµœì í™”**
    - í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
    - ì ì ˆí•œ ì¸ë±ìŠ¤ ì‚¬ìš©
    - ì¤‘ê°„ ê²°ê³¼ ì„ì‹œ í…Œì´ë¸” í™œìš©

### ë””ë²„ê¹… íŒ

1. ë‹¨ê³„ë³„ ì‹¤í–‰ ê²°ê³¼ í™•ì¸
2. ì‹¤í–‰ ê³„íš ë¶„ì„
3. ì†Œê·œëª¨ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸

## 6. ê²°ë¡ 

ì¬ê·€ ì¿¼ë¦¬ëŠ” ì ì ˆí•œ ì¢…ë£Œ ì¡°ê±´ê³¼ ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­ì„ ì—¼ë‘ì— ë‘ê³  êµ¬í˜„í•˜ë©´ ë³µì¡í•œ ë°ì´í„° êµ¬ì¡°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ê³„ì¸µì  ë°ì´í„° ì²˜ë¦¬ì— ê°•ë ¥í•œ ë„êµ¬ì´ë‹¤. ì¬ê·€ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ë•Œì—ëŠ” ì‹ ì¤‘í•œ ì„¤ê³„ì™€ ìµœì í™”ê°€ í•„ìˆ˜ì ì´ë‹¤. 

+) ì°¸ê³ ë¡œ ì¬ê·€ ì¿¼ë¦¬ì— ëŒ€í•œ ê°œë…ì€ SQLP(ì „ë¬¸ê°€) ì‹œí—˜ì— ë‚˜ì˜¨ë‹¤. ë‚˜ëŠ” SQLDê¹Œì§€ë§Œ ë•„ê¸° ë•Œë¬¸ì— ì±…ì„ ì•„ë¬´ë¦¬ ë’¤ì ¸ë„ ê°œë…ì´ ì•ˆë‚˜ì™€ì„œ ë‹¹í™©í–ˆëŠ”ë° ìƒê°ë³´ë‹¤ ê³ ê¸‰ ê°œë…ì¸ ê²ƒ ê°™ë‹¤.